% Script main_create_trajs
% Creates spiral & cartesian (FFE, EPI, multi-echo) trajectories from index file
%
% See also create_figure_trajectory_gradients
%
% Author: Maria Engel & Lars Kasper
% Created: 2016-04-06
% Copyright (C) 2016 Institute for Biomedical Engineering, ETH/Uni Zurich.

idSubject = 'SPIFI';

paths = spifi_get_paths();
options = spifi_get_analysis_options();

if ispc
    pathData = paths.data.trajectories;
    pathCode = paths.code.recon.trajectories;
    % add paths for traj creation
    addpath(genpath(paths.code.recon.root));
    addpath(genpath(pathCode));
end

pathThis = fileparts(mfilename('fullpath'));

fileNameIndex = fullfile(pathThis, ...
    sprintf('index_gradient_files_%s.m', idSubject));

% Leave out dxSArray(t) & fovSArray for 2D trajectories OR set to zero.
[idArray, fovMArray, fovPArray, fovSArray, dxMArray, dxPArray, dxSArray,...
    rPArray, rSArray, nIlArray, maxGArray, maxSrArray, tAcqArray, trajDirArray, ...
    trajTypeArray, scheme3DArray, nPlanesPerShotArray] = ...
    read_index_gradient_files(fileNameIndex);


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% Create Spirals
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

iTrajToPlotArray = options.session.iTrajArray;

for t = 22%iTrajToPlotArray
    
    create_matched_filter_spiral(...
        'FOV', [fovMArray(t) fovPArray(t) fovSArray(t)], ...
        'dx', [dxMArray(t) dxPArray(t) dxSArray(t)], ... % leave out dxSArray(t) for 2D trajectories
        'Rp', rPArray(t), ...
        'Rz', rSArray(t), ...
        'scheme3D', scheme3DArray{t}, ...
        'nPlanesPerShot', nPlanesPerShotArray(t), ...
        'nInterleaves', nIlArray(t), ...
        'verbose', 1, ...
        'idSubject', idSubject, ...
        'idGradientFolder', idArray(t), ...
        'trajectoryType', trajTypeArray{t}, ...
        'allowGaussBelowGmin', 0, ...
        'maxG', maxGArray(t), 'maxSlewRate', maxSrArray(t), ...
        'tAcqMax', tAcqArray(t), ...
        'directionSpiral', trajDirArray{t}, ...
        'doFullSampling', false, ...
        'doDetermineParametersFromIdGradientFolder', false, ...
        'pathCode', pathCode, ...
        'pathData', pathData, ...
        'interleafOrder', 'R1', ...
        'isBinary',0,...
        'nZeroFillEnd',0); %This was not set for LK397, but default is the same
end



%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% Create Cartesians (EPI/FFE, ME)
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

nExtraEchoes = trajDirArray;

% Why echo-shift as input parameter? Echo shift is not the right name, has
% a specific meaning for EPI, rather: delta_TE


for t = [] %[7]
    
    % echo-spacing different for different scans...
    switch idArray(t)
        case {14,41}
            delta_TE = 1/1026;
        case 43 % higher res
            delta_TE = 2/1026;
        otherwise
            delta_TE = 0;
    end
    
    main_create_smooth_readgrad_FFE(...
        'mp_switch', true, ...
        'subj', idSubject, ...
        'id', idArray(t), ...
        'traj_type', trajTypeArray{t}, ...
        'resolution', [dxMArray(t) dxPArray(t) dxSArray(t)], ...
        'Rp', rPArray(t), ...
        'Rz', rSArray(t), ...
        'FOV', [fovMArray(t) fovPArray(t) fovSArray(t)], ...
        'nPlanesPerShot', nPlanesPerShotArray(t), ...
        'maxG', maxGArray(t), 'maxSlewRate', maxSrArray(t), ...
        'interleaves', nIlArray(t), ...
        'vis_verbose', 1, ...
        'savedir', pathData, ...
        'n_zerofill_samples', 0, ...
        'n_extra_echoes_ffe', str2double(nExtraEchoes{t}), ...
        'delta_TE', repmat(delta_TE, 1, str2double(nExtraEchoes{t})));
end